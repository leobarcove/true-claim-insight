generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               String             @id @default(uuid())
  email            String             @unique
  password         String
  fullName         String
  phoneNumber      String
  role             UserRole
  licenseNumber    String?
  tenantId         String? // Deprecated: kept for backward compatibility
  currentTenantId  String? // Active tenant context for current session
  lastLoginAt      DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  adjuster         Adjuster?
  siuClaims        Claim[]            @relation("SIUInvestigator")
  tenant           Tenant?            @relation("UserPrimaryTenant", fields: [tenantId], references: [id])
  currentTenant    Tenant?            @relation("UserCurrentTenant", fields: [currentTenantId], references: [id])
  userTenants      UserTenant[]       // Many-to-many relationship with tenants
  tenantAccessLogs TenantAccessLog[]
  sessions         Session[]
  documents        Document[]
  documentAnalyses DocumentAnalysis[]
  trinityChecks    TrinityCheck[]
  deceptionScores  DeceptionScore[]
  riskAssessments  RiskAssessment[]
  videoUploads     VideoUpload[]
  claimants        Claimant[]
  otpCodes         OtpCode[]
  vehicleMakes     VehicleMake[]
  vehicleModels    VehicleModel[]
  claimNotes       ClaimNote[]
  sessionClientInfos SessionClientInfo[]
  auditTrails      AuditTrail[]
  claims           Claim[]


  @@index([tenantId])
  @@index([currentTenantId])
  @@index([email])
  @@map("users")
}

model UserTenant {
  id             String    @id @default(uuid())
  userId         String
  tenantId       String
  role           UserRole // Role specific to this tenant
  isDefault      Boolean   @default(false) // Default tenant for this user
  status         UserTenantStatus @default(ACTIVE)
  joinedAt       DateTime  @default(now())
  lastAccessedAt DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([userId])
  @@index([tenantId])
  @@index([userId, tenantId])
  @@map("user_tenants")
}

model TenantAccessLog {
  id            String   @id @default(uuid())
  userId        String
  fromTenantId  String?
  toTenantId    String
  ipAddress     String?
  userAgent     String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fromTenant    Tenant?  @relation("TenantAccessFrom", fields: [fromTenantId], references: [id], onDelete: SetNull)
  toTenant      Tenant   @relation("TenantAccessTo", fields: [toTenantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("tenant_access_logs")
}

model Tenant {
  id                  String            @id @default(uuid())
  name                String
  type                TenantType
  subscriptionTier    SubscriptionTier  @default(BASIC)
  settings            Json              @default("{}")
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt
  adjusters           Adjuster[]
  claims              Claim[]           @relation("InsurerClaims")
  users               User[]            @relation("UserPrimaryTenant") // Deprecated: for backward compatibility
  currentUsers        User[]            @relation("UserCurrentTenant") // Users currently in this tenant context
  userTenants         UserTenant[]      // Many-to-many relationship with users
  tenantAccessLogsFrom TenantAccessLog[] @relation("TenantAccessFrom")
  tenantAccessLogsTo   TenantAccessLog[] @relation("TenantAccessTo")
  sessions            Session[]
  claimNotes          ClaimNote[]
  deceptionScores     DeceptionScore[]
  riskAssessments     RiskAssessment[]
  documents           Document[]
  documentAnalyses    DocumentAnalysis[]
  trinityChecks       TrinityCheck[]
  auditLogs           AuditTrail[]
  videoUploads        VideoUpload[]
  sessionClientInfos  SessionClientInfo[]
  claimants           Claimant[]
  otpCodes            OtpCode[]
  vehicleMakes        VehicleMake[]
  vehicleModels       VehicleModel[]
  ownedClaims         Claim[]

  @@map("tenants")
}

model Adjuster {
  id                String         @id @default(uuid())
  userId            String         @unique
  tenantId          String
  licenseNumber     String         @unique
  bcillaCertified   Boolean        @default(false)
  amlaMember        Boolean        @default(false)
  status            AdjusterStatus @default(ACTIVE)
  licenseVerifiedAt DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  tenant            Tenant         @relation(fields: [tenantId], references: [id])
  user              User           @relation(fields: [userId], references: [id])
  claims            Claim[]

  @@index([tenantId])
  @@map("adjusters")
}

model Claimant {
  id            String    @id @default(uuid())
  nric          String?   @unique
  nricHash      String?   @unique
  nricEncrypted Bytes?
  fullName      String?
  dateOfBirth   DateTime?
  phoneNumber   String    @unique
  email         String?
  kycStatus     KycStatus @default(PENDING)
  kycVerifiedAt DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tenantId      String?   // Organization ownership
  userId        String?   // Creator/Link to User record
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])
  user          User?     @relation(fields: [userId], references: [id])
  claims        Claim[]

  @@index([phoneNumber])
  @@index([nric])
  @@index([tenantId])
  @@index([userId])
  @@map("claimants")
}

model OtpCode {
  id          String   @id @default(uuid())
  phoneNumber String
  code        String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())
  tenantId    String?  // Associated tenant if known
  userId      String?  // Associated user if known
  tenant      Tenant?  @relation(fields: [tenantId], references: [id])
  user        User?    @relation(fields: [userId], references: [id])

  @@index([phoneNumber, code])
  @@index([expiresAt])
  @@index([tenantId])
  @@index([userId])
  @@map("otp_codes")
}

model Claim {
  id                      String      @id @default(uuid())
  claimNumber             String      @unique
  claimantId              String
  nric                    String?
  adjusterId              String?
  insurerTenantId         String?
  policyNumber            String
  claimType               ClaimType
  status                  ClaimStatus @default(SUBMITTED)
  incidentDate            DateTime
  incidentTime            DateTime?
  incidentLocation        Json
  description             String
  otherParty              Json?
  policeReportNumber      String?
  policeStation           String?
  policeReportDate        DateTime?
  vehiclePlateNumber      String?
  vehicleChassisNumber    String?
  vehicleMake             String?
  vehicleModel            String?
  ncdRate                 Float?
  sumInsured              Decimal?
  workshopName            String?
  estimatedLossAmount     Decimal?
  estimatedRepairCost     Decimal?    @db.Decimal(12, 2)
  sstAmount               Decimal?
  isPdpaCompliant         Boolean     @default(false)
  slaDeadline             DateTime?
  complianceNotes         Json?       @default("{}")
  priority                Priority    @default(NORMAL)
  scheduledAssessmentTime DateTime?
  siuInvestigatorId       String?
  approvedAmount          Decimal?
  excessAmount            Decimal?
  vehicleEngineNumber     String?
  vehicleYear             Int?
  tenantId                String?     // Standardized tenant ownership
  userId                  String?     // Standardized creator/owner
  createdById             String?     // Keeping for backward compatibility
  updatedById             String?
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt
  notes                   ClaimNote[]
  adjuster                Adjuster?   @relation(fields: [adjusterId], references: [id])
  claimant                Claimant    @relation(fields: [claimantId], references: [id])
  tenant                  Tenant?     @relation(fields: [tenantId], references: [id])
  user                    User?       @relation(fields: [userId], references: [id])
  insurerTenant           Tenant?     @relation("InsurerClaims", fields: [insurerTenantId], references: [id])
  siuInvestigator         User?       @relation("SIUInvestigator", fields: [siuInvestigatorId], references: [id])
  documents               Document[]
  sessions                Session[]
  videoUploads            VideoUpload[]
  trinityChecks           TrinityCheck[]

  @@index([claimantId])
  @@index([nric])
  @@index([adjusterId])
  @@index([status])
  @@index([tenantId])
  @@index([userId])
  @@index([createdAt(sort: Desc)])
  @@map("claims")
}

model ClaimNote {
  id         String    @id @default(uuid())
  claimId    String
  content    String
  isPrivate  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  tenantId   String?   // Organization ownership
  userId     String?   // Creator (linked to User)
  authorId   String    // Generic author ID (can be user or claimant)
  authorType ActorType
  claim      Claim     @relation(fields: [claimId], references: [id])
  tenant     Tenant?   @relation(fields: [tenantId], references: [id])
  user       User?     @relation(fields: [userId], references: [id])

  @@index([claimId])
  @@index([tenantId])
  @@index([userId])
  @@map("claim_notes")
}

model Session {
  id              String           @id @default(uuid())
  claimId         String
  tenantId        String? // Tenant context for this session
  roomId          BigInt
  status          SessionStatus    @default(SCHEDULED)
  scheduledTime   DateTime?
  startedAt       DateTime?
  endedAt         DateTime?
  durationSeconds Int?
  recordingUrl    String?
  analysisStatus  AnalysisStatus   @default(PENDING)
  screenshots     Json             @default("[]")
  createdAt       DateTime         @default(now())
  roomUrl         String?
  riskAssessments RiskAssessment[]
  deceptionScores DeceptionScore[]
  clientInfos     SessionClientInfo[]
  claim           Claim            @relation(fields: [claimId], references: [id])
  tenant          Tenant?          @relation(fields: [tenantId], references: [id])
  userId          String?          // User who scheduled/initiated
  user            User?            @relation(fields: [userId], references: [id])

  @@index([claimId])
  @@index([tenantId])
  @@map("sessions")
}

model DeceptionScore {
  id                    String   @id @default(uuid())
  sessionId             String
  deceptionScore        Decimal  @db.Decimal(5, 4)
  voiceStress           Decimal  @db.Decimal(5, 4)
  visualBehavior        Decimal  @db.Decimal(5, 4)
  expressionMeasurement Decimal  @db.Decimal(5, 4)
  createdAt             DateTime @default(now())
  tenantId              String?  // Denormalized for reporting
  userId                String?  // Who triggered analysis
  session               Session  @relation(fields: [sessionId], references: [id])
  tenant                Tenant?  @relation(fields: [tenantId], references: [id])
  user                  User?    @relation(fields: [userId], references: [id])

  @@index([sessionId])
  @@map("deception_scores")
}

model RiskAssessment {
  id             String         @id @default(uuid())
  sessionId      String
  assessmentType AssessmentType
  provider       String
  questionId     String?
  questionText   String?
  riskScore      RiskScore?
  confidence     Decimal?       @db.Decimal(5, 4)
  rawResponse    Json?
  contextData    Json?
  createdAt      DateTime       @default(now())
  tenantId       String?        // Denormalized for reporting
  userId         String?        // Who triggered analysis
  session        Session        @relation(fields: [sessionId], references: [id])
  tenant         Tenant?        @relation(fields: [tenantId], references: [id])
  user           User?          @relation(fields: [userId], references: [id])

  @@index([sessionId, assessmentType])
  @@index([sessionId])
  @@map("risk_assessments")
}

model Document {
  id           String       @id @default(uuid())
  claimId      String
  type         DocumentType
  filename     String
  storageUrl   String
  fileSize     Int?
  mimeType     String?
  status       DocumentStatus @default(QUEUED)
  metadata     Json         @default("{}")
  signedAt     DateTime?
  documentHash String?
  createdAt    DateTime     @default(now())
  tenantId     String?      // Organization ownership
  userId       String?      // Uploader ID
  claim        Claim             @relation(fields: [claimId], references: [id])
  tenant       Tenant?           @relation(fields: [tenantId], references: [id])
  user         User?             @relation(fields: [userId], references: [id])
  analysis     DocumentAnalysis?

  @@index([claimId])
  @@map("documents")
}

model DocumentAnalysis {
  id            String   @id @default(uuid())
  documentId    String   @unique
  rawText       String?  // OCR text
  extractedData Json?    // Normalized data from LLM
  visionData    Json?    // Vision analysis result from VLM
  modelUsed     String?
  confidence    Float?
  processingTime Int?    // in ms
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  tenantId      String?  // Organization ownership
  userId        String?  // Who triggered analysis
  document      Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  tenant        Tenant?  @relation(fields: [tenantId], references: [id])
  user          User?    @relation(fields: [userId], references: [id])

  @@map("document_analyses")
}

model TrinityCheck {
  id                String   @id @default(uuid())
  claimId           String
  claim             Claim    @relation(fields: [claimId], references: [id], onDelete: Cascade)
  score             Float?   // 0.0 to 100.0
  status            String   // PASS, FAIL, WARNING, REVIEW_NEEDED
  summary           String?
  checkResults      Json     // Detailed pass/fail for each rule
  riskFactors       Json     // Identified risks
  reasoning         String?  @db.Text
  reasoningInsights Json?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  tenantId          String?  // Organization ownership
  userId            String?  // Triggered by
  tenant            Tenant?  @relation(fields: [tenantId], references: [id])
  user              User?    @relation(fields: [userId], references: [id])

  @@index([claimId])
  @@map("trinity_checks")
}

model AuditTrail {
  id         String     @id @default(uuid())
  entityType String
  entityId   String
  action     String
  actorId    String?
  actorType  ActorType?
  ipAddress  String?
  userAgent  String?
  oldValues  Json?
  newValues  Json?
  metadata   Json?
  createdAt  DateTime   @default(now())
  tenantId   String?    // Tenant context for this audit event
  userId     String?    // User context
  tenant     Tenant?    @relation(fields: [tenantId], references: [id])
  user       User?      @relation(fields: [userId], references: [id])

  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@index([tenantId])
  @@index([userId])
  @@map("audit_trail")
}

enum UserRole {
  ADJUSTER
  FIRM_ADMIN
  CLAIMANT
  INSURER_STAFF
  INSURER_ADMIN
  SUPER_ADMIN
  SIU_INVESTIGATOR
  COMPLIANCE_OFFICER
  SUPPORT_DESK
  SHARIAH_REVIEWER
}

enum TenantType {
  ADJUSTING_FIRM
  INSURER
}

enum SubscriptionTier {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum AdjusterStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum KycStatus {
  PENDING
  VERIFIED
  FAILED
  EXPIRED
}

enum UserTenantStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING_APPROVAL
}


enum ClaimType {
  OWN_DAMAGE
  THIRD_PARTY_PROPERTY
  THIRD_PARTY_INJURY
  THEFT
  WINDSCREEN
}

enum ClaimStatus {
  SUBMITTED
  DOCUMENTS_PENDING
  PENDING_ASSIGNMENT
  ASSIGNED
  SCHEDULED
  IN_ASSESSMENT
  REPORT_PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  ESCALATED_SIU
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SessionStatus {
  SCHEDULED
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum AnalysisStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AssessmentType {
  VOICE_ANALYSIS
  VISUAL_MODERATION
  ATTENTION_TRACKING
  DEEPFAKE_CHECK
}

enum RiskScore {
  LOW
  MEDIUM
  HIGH
}

enum DocumentType {
  DAMAGE_PHOTO
  POLICE_REPORT
  DRIVING_LICENCE
  ASSESSMENT_REPORT
  SIGNED_STATEMENT
  MYKAD_FRONT
  VEHICLE_REG_CARD
  REPAIR_QUOTATION
  POLICY_DOCUMENT
  NRIC
  OTHER_DOCUMENT
  CLAIMANT_SCREENSHOT
}

enum ActorType {
  CLAIMANT
  ADJUSTER
  ADMIN
  SYSTEM
}

enum DocumentStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
}

model VideoUpload {
  id             String            @id @default(uuid())
  claimId        String
  videoUrl       String
  filename       String
  fileSize       Int
  mimeType       String
  duration       Float?            // in seconds
  processedUntil Float             @default(0) // seconds processed so far
  status         VideoUploadStatus @default(PENDING)
  uploadedBy     String?           // user ID (deprecated, use userId)
  userId         String?           // Who uploaded
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  tenantId       String?           // Organization ownership
  claim          Claim             @relation(fields: [claimId], references: [id])
  tenant         Tenant?           @relation(fields: [tenantId], references: [id])
  user           User?             @relation(fields: [userId], references: [id])

  @@index([claimId])
  @@index([status])
  @@map("video_uploads")
}

enum VideoUploadStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}


model VehicleMake {
  id        String         @id @default(uuid())
  name      String         @unique
  models    VehicleModel[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
  tenantId  String?        // Organization ownership
  userId    String?        // Creator
  tenant    Tenant?        @relation(fields: [tenantId], references: [id])
  user      User?          @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([userId])
  @@map("vehicle_makes")
}

model VehicleModel {
  id        String      @id @default(uuid())
  name      String
  makeId    String
  make      VehicleMake @relation(fields: [makeId], references: [id], onDelete: Cascade)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  tenantId  String?     // Organization ownership
  userId    String?     // Creator
  tenant    Tenant?     @relation(fields: [tenantId], references: [id])
  user      User?       @relation(fields: [userId], references: [id])

  @@unique([makeId, name])
  @@index([makeId])
  @@index([tenantId])
  @@index([userId])
  @@map("vehicle_models")
}

model SessionClientInfo {
  id               String   @id @default(uuid())
  sessionId        String
  session          Session  @relation(fields: [sessionId], references: [id])
  latitude         Float?
  longitude        Float?
  ipv4             String?
  ipv6             String?
  userAgent        String?
  language         String?
  browser          String?
  platform         String?
  screenResolution String?
  timezone         String?
  
  // ISP Info
  city             String?
  region           String?
  country          String?
  postalCode       String?
  isp              String?
  organisation     String?
  asn              String?
  
  metadata         Json?    @default("{}")
  createdAt        DateTime @default(now())
  tenantId         String?  // Organization info
  userId           String?  // Associated user session
  tenant           Tenant?  @relation(fields: [tenantId], references: [id])
  user             User?    @relation(fields: [userId], references: [id])

  @@index([sessionId])
  @@index([tenantId])
  @@index([userId])
  @@map("session_client_info")
}
