generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  fullName      String
  phoneNumber   String
  role          UserRole
  licenseNumber String?
  tenantId      String?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  tenant        Tenant?   @relation(fields: [tenantId], references: [id])
  adjuster      Adjuster?
  siuClaims     Claim[]   @relation("SIUInvestigator")

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model Tenant {
  id               String           @id @default(uuid())
  name             String
  type             TenantType
  subscriptionTier SubscriptionTier @default(BASIC)
  settings         Json             @default("{}")
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  adjusters        Adjuster[]
  claims           Claim[]          @relation("InsurerClaims")
  users            User[]

  @@map("tenants")
}

model Adjuster {
  id                String         @id @default(uuid())
  userId            String         @unique
  tenantId          String
  licenseNumber     String         @unique
  bcillaCertified   Boolean        @default(false)
  amlaMember        Boolean        @default(false)
  status            AdjusterStatus @default(ACTIVE)
  licenseVerifiedAt DateTime?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  user              User           @relation(fields: [userId], references: [id])
  tenant            Tenant         @relation(fields: [tenantId], references: [id])
  claims            Claim[]

  @@index([tenantId])
  @@map("adjusters")
}

model Claimant {
  id            String    @id @default(uuid())
  nricHash      String?   @unique
  nricEncrypted Bytes?
  fullName      String?
  dateOfBirth   DateTime?
  phoneNumber   String    @unique
  email         String?
  kycStatus     KycStatus @default(PENDING)
  kycVerifiedAt DateTime?
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  claims        Claim[]

  @@index([phoneNumber])
  @@map("claimants")
}

model OtpCode {
  id          String   @id @default(uuid())
  phoneNumber String
  code        String
  expiresAt   DateTime
  verified    Boolean  @default(false)
  attempts    Int      @default(0)
  createdAt   DateTime @default(now())

  @@index([phoneNumber, code])
  @@index([expiresAt])
  @@map("otp_codes")
}

model Claim {
  id                      String      @id @default(uuid())
  claimNumber             String      @unique
  claimantId              String
  adjusterId              String?
  insurerTenantId         String?
  policyNumber            String
  claimType               ClaimType
  status                  ClaimStatus @default(SUBMITTED)
  incidentDate            DateTime
  incidentTime            DateTime?
  incidentLocation        Json
  description             String
  otherParty              Json?
  policeReportNumber      String?
  policeStation           String?
  policeReportDate        DateTime?
  vehiclePlateNumber      String?
  vehicleChassisNumber    String?     // New: Compliance
  vehicleMake             String?
  vehicleModel            String?
  ncdRate                 Float?      // New: Policy Info (0.00 to 1.00)
  sumInsured              Decimal?    // New: Policy Info
  workshopName            String?
  estimatedLossAmount     Decimal?    // New: Financials
  estimatedRepairCost     Decimal?    @db.Decimal(12, 2)
  sstAmount               Decimal?    // New: Financials
  isPdpaCompliant         Boolean     @default(false)
  slaDeadline             DateTime?
  complianceNotes         Json?       @default("{}")
  priority                Priority    @default(NORMAL)
  scheduledAssessmentTime DateTime?
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt
  notes                   ClaimNote[]
  adjuster                Adjuster?   @relation(fields: [adjusterId], references: [id])
  claimant                Claimant    @relation(fields: [claimantId], references: [id])
  insurerTenant           Tenant?     @relation("InsurerClaims", fields: [insurerTenantId], references: [id])
  siuInvestigator         User?       @relation("SIUInvestigator", fields: [siuInvestigatorId], references: [id])
  siuInvestigatorId       String?
  documents               Document[]
  sessions                Session[]

  @@index([claimantId])
  @@index([adjusterId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("claims")
}

model ClaimNote {
  id         String    @id @default(uuid())
  claimId    String
  authorId   String
  authorType ActorType
  content    String
  isPrivate  Boolean   @default(false)
  createdAt  DateTime  @default(now())
  claim      Claim     @relation(fields: [claimId], references: [id])

  @@index([claimId])
  @@map("claim_notes")
}

model Session {
  id              String           @id @default(uuid())
  claimId         String
  roomId          BigInt
  status          SessionStatus    @default(SCHEDULED)
  scheduledTime   DateTime?
  startedAt       DateTime?
  endedAt         DateTime?
  durationSeconds Int?
  recordingUrl    String?
  screenshots     Json             @default("[]")
  createdAt       DateTime         @default(now())
  roomUrl         String?
  riskAssessments RiskAssessment[]
  claim           Claim            @relation(fields: [claimId], references: [id])

  @@index([claimId])
  @@map("sessions")
}

model RiskAssessment {
  id             String         @id @default(uuid())
  sessionId      String
  assessmentType AssessmentType
  provider       String
  questionId     String?
  questionText   String?
  riskScore      RiskScore?
  confidence     Decimal?       @db.Decimal(5, 4)
  rawResponse    Json?
  contextData    Json?
  createdAt      DateTime       @default(now())
  session        Session        @relation(fields: [sessionId], references: [id])

  @@index([sessionId])
  @@map("risk_assessments")
}

model Document {
  id           String       @id @default(uuid())
  claimId      String
  type         DocumentType
  filename     String
  storageUrl   String
  fileSize     Int?
  mimeType     String?
  metadata     Json         @default("{}")
  signedAt     DateTime?
  documentHash String?
  createdAt    DateTime     @default(now())
  claim        Claim        @relation(fields: [claimId], references: [id])

  @@index([claimId])
  @@map("documents")
}

model AuditTrail {
  id         String     @id @default(uuid())
  entityType String
  entityId   String
  action     String
  actorId    String?
  actorType  ActorType?
  ipAddress  String?
  userAgent  String?
  oldValues  Json?
  newValues  Json?
  metadata   Json?
  createdAt  DateTime   @default(now())

  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
  @@map("audit_trail")
}

enum UserRole {
  ADJUSTER
  FIRM_ADMIN
  CLAIMANT
  INSURER_STAFF
  INSURER_ADMIN
  SUPER_ADMIN
  SIU_INVESTIGATOR
  COMPLIANCE_OFFICER
  SUPPORT_DESK
  SHARIAH_REVIEWER
}

enum TenantType {
  ADJUSTING_FIRM
  INSURER
}

enum SubscriptionTier {
  BASIC
  PROFESSIONAL
  ENTERPRISE
}

enum AdjusterStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum KycStatus {
  PENDING
  VERIFIED
  FAILED
  EXPIRED
}

enum ClaimType {
  OWN_DAMAGE
  THIRD_PARTY_PROPERTY
  THIRD_PARTY_INJURY
  THEFT
  WINDSCREEN
}

enum ClaimStatus {
  SUBMITTED
  DOCUMENTS_PENDING
  PENDING_ASSIGNMENT
  ASSIGNED
  SCHEDULED
  IN_ASSESSMENT
  REPORT_PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
  ESCALATED_SIU
  CLOSED
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SessionStatus {
  SCHEDULED
  WAITING
  IN_PROGRESS
  COMPLETED
  CANCELLED
  FAILED
}

enum AssessmentType {
  VOICE_ANALYSIS
  VISUAL_MODERATION
  ATTENTION_TRACKING
  DEEPFAKE_CHECK
}

enum RiskScore {
  LOW
  MEDIUM
  HIGH
}

enum DocumentType {
  DAMAGE_PHOTO
  POLICE_REPORT
  DRIVING_LICENCE
  ASSESSMENT_REPORT
  SIGNED_STATEMENT
}

enum ActorType {
  CLAIMANT
  ADJUSTER
  ADMIN
  SYSTEM
}
